<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nurse Call System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .alert-pulse {
            animation: pulse 2s infinite;
        }
        .alert-completed {
            animation: none;
            transition: opacity 0.5s ease-out;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        @keyframes fab-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }
        .animate-fab-bounce {
            animation: fab-bounce 2.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="notification-container" class="fixed top-4 right-4 z-50"></div>

    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-blue-800">Nurse Call System</h1>
                <p class="text-gray-600">Monitor patient calls in real-time</p>
            </div>
            <div class="flex items-center space-x-4">
                <div id="standby-indicator-card" class="bg-white p-3 rounded-lg shadow flex items-center">
                    <span id="standby-indicator" class="inline-block w-3 h-3 rounded-full bg-red-500 mr-2"></span>
                    <span class="font-mono">Standby</span>
                </div>
                <div id="sounds-indicator-card" class="bg-white p-3 rounded-lg shadow flex items-center">
                    <span id="sounds-indicator" class="inline-block w-3 h-3 rounded-full bg-red-500 mr-2"></span>
                    <span class="font-mono">Sounds</span>
                </div>
                <div class="bg-white p-3 rounded-lg shadow flex items-center">
                    <i class="fas fa-clock text-blue-500 mr-2"></i>
                    <span id="current-time" class="font-mono">00:00:00</span>
                </div>
                <div class="bg-white p-3 rounded-lg shadow flex items-center">
                    <i class="fas fa-calendar-day text-blue-500 mr-2"></i>
                    <span id="current-date" class="font-mono">01/01/2023</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-6">
            <div class="col-span-2 row-span-2 bg-white p-6 rounded-lg shadow h-[calc(100vh-9.5rem)]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-blue-700">
                        <i class="fas fa-history mr-2"></i>Call History
                    </h2>
                    <button id="clear-history" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded">
                        <i class="fas fa-trash-alt mr-1"></i> Clear History
                    </button>
                </div>
                
                <div class="h-[calc(100%-4rem)] overflow-y-auto custom-scrollbar overflow-x-hidden">
                    <table class="w-full bg-white table-fixed">
                        <thead class="sticky top-0 bg-white z-10 shadow-sm">
                            <tr class="bg-gray-100 text-gray-700 text-sm">
                                <th class="py-2 px-2 text-left w-16">Kode</th>
                                <th class="py-2 px-2 text-left w-28">Kamar</th>
                                <th class="py-2 px-2 text-left w-20">Bed</th>
                                <th class="py-2 px-2 text-left w-36">Time</th>
                                <th class="py-2 px-2 text-left w-36">Response Time</th>
                                <th class="py-2 px-2 text-left w-20">Elapse</th>
                                <th class="py-2 px-2 text-left w-12">ST</th>
                            </tr>
                        </thead>
                        <tbody id="call-history" class="divide-y divide-gray-200 text-sm">
                            <tr>
                                <td colspan="7" class="py-4 text-center text-gray-500">
                                    No call history yet
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4 text-blue-700">
                    <i class="fas fa-vial mr-2"></i>Test Panel
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-2">Simulate Call</label>
                        <div class="flex space-x-2">
                            <input type="text" id="test-chip-id" placeholder="Chip ID" class="flex-1 p-2 border rounded focus:ring-2 focus:ring-blue-500">
                            <button id="test-call" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded">
                                <i class="fas fa-bell mr-1"></i> Test
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 mb-2">Manual Input</label>
                        <div class="flex">
                            <input type="text" id="manual-input" placeholder="Enter call code (e.g., 101)" class="flex-1 p-2 border rounded-l focus:ring-2 focus:ring-blue-500">
                            <button id="manual-submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-r">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700">
                        <p class="text-sm">
                            <i class="fas fa-info-circle mr-2"></i>
                            Masukkan Chip ID dan kode panggilan untuk simulasi nurse call.
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow h-[calc(100vh-32rem)]">
                <h2 class="text-xl font-semibold mb-4 text-blue-700">
                    <i class="fas fa-bell mr-2"></i>Active Alerts
                </h2>
                
                <div id="active-alerts" class="h-[calc(100%-4rem)] overflow-y-auto custom-scrollbar">
                    <div class="flex flex-col justify-center items-center text-gray-400 h-full">
                        <i class="fas fa-bell-slash text-6xl mb-2"></i>
                        <p class="text-lg">Tidak ada peringatan aktif</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-8 right-8 flex flex-col items-end space-y-4 z-50">
        <button id="fab-display" title="Display" class="mb-2 bg-purple-600 hover:bg-purple-700 text-white rounded-full shadow-lg w-16 h-16 flex items-center justify-center animate-fab-bounce relative group">
            <i class="fas fa-desktop text-2xl"></i>
            <span class="absolute right-20 top-1/2 -translate-y-1/2 bg-gray-800 text-white text-xs rounded px-2 py-1 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">Display</span>
        </button>
        <button id="fab-master-settings" title="Master Data" class="mb-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-full shadow-lg w-16 h-16 flex items-center justify-center animate-fab-bounce relative group">
            <i class="fas fa-database text-2xl"></i>
            <span class="absolute right-20 top-1/2 -translate-y-1/2 bg-gray-800 text-white text-xs rounded px-2 py-1 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">Master Data</span>
        </button>
        <button id="fab-master-settings2" title="Master Settings" class="mb-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg w-16 h-16 flex items-center justify-center animate-fab-bounce relative group">
            <i class="fas fa-tools text-2xl"></i>
            <span class="absolute right-20 top-1/2 -translate-y-1/2 bg-gray-800 text-white text-xs rounded px-2 py-1 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">Master Settings</span>
        </button>
        <button id="fab-alerts-settings" title="Alerts Settings" class="bg-green-700 hover:bg-green-800 text-white rounded-full shadow-lg w-16 h-16 flex items-center justify-center animate-fab-bounce relative group">
            <i class="fas fa-bell text-2xl"></i>
            <span class="absolute right-20 top-1/2 -translate-y-1/2 bg-gray-800 text-white text-xs rounded px-2 py-1 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">Alerts Settings</span>
        </button>
    </div>

    <!-- Master Settings Modal -->
    <div id="master-settings-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-5 border w-11/12 max-w-7xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900"><i class="fas fa-database mr-2"></i>Master Data</h3>
                <button id="close-master-settings" class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mb-4 flex space-x-2">
                <button id="new-master-data" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded flex items-center">
                    <i class="fas fa-plus mr-2"></i> New
                </button>
                <button id="delete-master-data" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded flex items-center">
                    <i class="fas fa-trash mr-2"></i> Delete
                </button>
                <button id="save-master-data" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded flex items-center">
                    <i class="fas fa-save mr-2"></i> Save
                </button>
                <button id="import-sounds" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded flex items-center">
                    <i class="fas fa-file-audio mr-2"></i> Import Sounds
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border text-sm">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-2 px-2 border w-12 text-center">ID</th>
                            <th class="py-2 px-2 border w-32">Chip ID</th>
                            <th class="py-2 px-2 border w-16">Code</th>
                            <th class="py-2 px-2 border w-32">Room Name</th>
                            <th class="py-2 px-2 border w-24">Bed Name</th>
                            <th class="py-2 px-2 border w-16">Shape</th>
                            <th class="py-2 px-2 border w-16">SA</th>
                            <th class="py-2 px-2 border w-24">V1</th>
                            <th class="py-2 px-2 border w-24">V2</th>
                            <th class="py-2 px-2 border w-24">V3</th>
                            <th class="py-2 px-2 border w-24">V4</th>
                            <th class="py-2 px-2 border w-24">V5</th>
                            <th class="py-2 px-2 border w-24">V6</th>
                        </tr>
                    </thead>
                    <tbody id="master-settings-table">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Alerts Settings Modal -->
    <div id="alerts-settings-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900">Alerts Settings</h3>
                <button id="close-alerts-settings" class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="alerts-settings-content">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Display Format</label>
                    <select id="display-format" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                        <option value="K{room}B{bed}">K{room}B{bed} (e.g., K1B1)</option>
                        <option value="Room {room} Bed {bed}">Room {room} Bed {bed}</option>
                        <option value="Bed {bed}, Room {room}">Bed {bed}, Room {room}</option>
                        <option value="R{room}-B{bed}">R{room}-B{bed}</option>
                        <option value="custom">Custom Format</option>
                    </select>
                </div>
                
                <div id="custom-format-container" class="mb-4 hidden">
                    <label class="block text-gray-700 mb-2">Custom Format</label>
                    <input type="text" id="custom-format" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" placeholder="e.g., Room-{room}_Bed-{bed}">
                    <p class="text-xs text-gray-500 mt-1">Use {room} for room number and {bed} for bed number</p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Alert Duration (seconds)</label>
                    <input type="number" id="alert-duration" min="5" max="600" value="30" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex items-center mb-4">
                    <input type="checkbox" id="sound-alert" class="mr-2 h-5 w-5">
                    <label for="sound-alert" class="text-gray-700">Enable Sound Alert</label>
                </div>
                
                <button id="apply-settings" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded flex items-center justify-center">
                    <i class="fas fa-save mr-2"></i> Apply Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Master Data Password Modal -->
    <div id="master-data-password-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-semibold mb-4 text-center">Masukkan Password Master Data</h3>
            <div class="w-full mb-4">
                <input type="password" id="master-data-password-input" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" placeholder="Password">
                <div id="master-data-password-error" class="text-red-500 text-sm mt-1 hidden">Password salah!</div>
            </div>
            <div class="flex justify-center space-x-2">
                <button id="master-data-password-submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Submit</button>
                <button id="master-data-password-cancel" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Master Settings 2 Modal -->
    <div id="master-settings2-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-5 border w-full max-w-6xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900"><i class="fas fa-tools mr-2"></i>Master Settings</h3>
                <button id="close-master-settings2" class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Grid layout untuk 2 kolom -->
            <div class="grid grid-cols-2 gap-6">
                <!-- Kolom kiri: COM Port dan Serial Monitor -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-2">COM Port</label>
                        <select id="master-com" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                            <option value="">Select COM Port</option>
                        </select>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 italic">
                            <i class="fas fa-info-circle mr-1"></i>
                            Baud rate must be 9600
                        </p>
                    </div>
                    <div>
                        <button id="master-connection-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded flex items-center justify-center">
                            <i class="fas fa-plug mr-2"></i> Connect
                        </button>
                    </div>
                    <div class="mt-4 p-3 bg-gray-100 rounded hidden" id="master-connection-status">
                        <p class="text-sm flex items-center">
                            <i class="fas fa-circle mr-2 text-gray-500"></i>
                            <span>Disconnected</span>
                        </p>
                    </div>
                    <div id="serial-monitor" class="mt-4 p-3 bg-gray-100 rounded hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-sm font-semibold">Serial Monitor</h4>
                            <div class="flex space-x-2">
                                <button id="get-chip-data-btn" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded">
                                    <i class="fas fa-microchip"></i> Get Chip Data
                                </button>
                                <button id="clear-monitor" class="text-xs text-gray-600 hover:text-gray-800">
                                    <i class="fas fa-trash-alt"></i> Clear
                                </button>
                            </div>
                        </div>
                        <div id="serial-data" class="h-48 overflow-y-auto bg-white p-2 rounded text-xs font-mono"></div>
                    </div>
                </div>

                <!-- Kolom kanan: Input fields -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-2">Name</label>
                        <input type="text" id="master-name" class="w-full p-2 border rounded" placeholder="Name">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Bot</label>
                        <input type="text" id="master-bot" class="w-full p-2 border rounded" placeholder="Bot">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ID Chat</label>
                        <input type="text" id="master-idchat" class="w-full p-2 border rounded" placeholder="ID Chat">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Server</label>
                        <input type="text" id="master-server" class="w-full p-2 border rounded" placeholder="Server">
                    </div>
                    <div class="pt-4">
                        <button id="master-save-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded flex items-center justify-center">
                            <i class="fas fa-save mr-2"></i> Save
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <audio id="alert-sound" src="sounds/ding.wav" preload="auto"></audio>

    <script>
        const { ipcRenderer } = require('electron');

        // Tambahkan variabel status koneksi
        let masterIsConnected = false;
        let masterSelectedPort = "";
        let isConnected = false;
        let standbyMode = false;
        let lastStandbyTime = 0; // Tambahkan variabel untuk tracking waktu standby terakhir

        function updateDateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
            const dateStr = now.toLocaleDateString('en-GB');
            document.getElementById('current-time').textContent = timeStr;
            document.getElementById('current-date').textContent = dateStr;

            // Cek timeout standby setiap detik
            if (standbyMode) {
                const currentTime = Date.now();
                if (currentTime - lastStandbyTime > 2000) { // 2 detik timeout
                    standbyMode = false;
                    updateConnectionStatus();
                    showNotification('info', 'Sistem keluar dari mode standby (timeout)');
                    addDebugMessage('Standby mode OFF (timeout)', 'success');
                }
            }
        }
        
        setInterval(updateDateTime, 1000);
        updateDateTime();

        let callHistory = [];
        let activeAlerts = [];
        let displayFormat = "K{room}B{bed}";
        let alertDuration = 30;
        let soundEnabled = false;

        let masterData = [];
        let selectedRow = null;
        let nextId = 1;
        let soundFiles = [];

        let alertSettings = {
            displayFormat: "K{room}B{bed}",
            alertDuration: 30,
            soundEnabled: false,
            customFormat: ""
        };

        let masterSettings = {
            com: "",
            name: "",
            bot: "",
            idChat: "",
            server: ""
        };

        function reattachEventListener(elementId, eventType, handler) {
            const element = document.getElementById(elementId);
            if (element) {
                const clone = element.cloneNode(true);
                element.parentNode.replaceChild(clone, element);
                clone.addEventListener(eventType, handler);
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            updateDateTime();
            
            // Tampilkan notifikasi booting dengan urutan yang benar
            const portCheck = showNotification('info', 'Mengecek Koneksi Port . . .');
            
            // Cek koneksi port
            const data = await ipcRenderer.invoke('load-config');
            if (data.masterSettings && data.masterSettings.com) {
                try {
                    // Coba koneksi ke port
                    await ipcRenderer.invoke('connect-port', { port: data.masterSettings.com, baudRate: 9600 });
                    
                    // Tunggu 3 detik, hilangkan notifikasi port check
                    setTimeout(() => {
                        portCheck.remove();
                        
                        // Tampilkan notifikasi port terkoneksi
                        const portConnected = showNotification('success', `Terhubung ke Port Serial (${data.masterSettings.com})`);
                        
                        // Tunggu 2 detik, hilangkan notifikasi port terkoneksi
                        setTimeout(() => {
                            portConnected.remove();
                            
                            // Tampilkan notifikasi cek file sound
                            const soundCheck = showNotification('info', 'Mengecek File Sound . . .');
                            
                            loadSoundFiles();
                            
                            // Tunggu 3 detik, hilangkan notifikasi cek sound
                            setTimeout(() => {
                                soundCheck.remove();
                                
                                // Tampilkan hasil pengecekan file sound
                                if (soundFiles.length > 0) {
                                    showNotification('success', `File Sound ditemukan (${soundFiles.length} file)`);
                                } else {
                                    showNotification('warning', 'Tidak ditemukan file sound');
                                }
                            }, 3000);
                        }, 2000);
                    }, 3000);
                } catch (error) {
                    // Port sibuk atau error
                    setTimeout(() => {
                        portCheck.remove();
                        showNotification('error', 'Port Serial Sibuk, Mohon di Cek Kembali');
                    }, 3000);
                }
            } else {
                // Port belum ditentukan
                setTimeout(() => {
                    portCheck.remove();
                    showNotification('warning', 'Port Serial belum di tentukan, silahkan anda ke <i class="fas fa-tools"></i> Master Settings');
                }, 3000);
            }
            
            const testCall = document.getElementById('test-call');
            const testChipId = document.getElementById('test-chip-id');
            const manualInput = document.getElementById('manual-input');
            const manualSubmit = document.getElementById('manual-submit');

            if (testCall) {
                testCall.addEventListener('click', function() {
                    const chipId = testChipId.value;
                    const code = manualInput.value;
                
                    if (chipId && code) {
                        if (!isValidCharCode(code)) {
                            manualInput.value = '';
                            return;
                        }
                        processCall(code, chipId);
                        manualInput.value = '';
                    } else {
                        alert('Silakan masukkan Chip ID dan kode panggilan');
                    }
                });
            }

            if (manualSubmit) {
                manualSubmit.addEventListener('click', function() {
                    const chipId = testChipId.value;
                    const code = manualInput.value.trim();
                    
                    if (chipId && code) {
                        if (!isValidCharCode(code)) {
                            showNotification('warning', 'Kode panggilan tidak valid', 5000);
                            manualInput.value = '';
                            return;
                        }
                        processCall(code, chipId);
                        manualInput.value = '';
                    } else {
                        showNotification('warning', 'Silakan masukkan Chip ID dan kode panggilan', 5000);
                    }
                });
            }
            
            if (manualInput) {
                manualInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        manualSubmit.click();
                    }
                });
            }

            const saveMasterData = document.getElementById('save-master-data');
            if (saveMasterData) {
                saveMasterData.addEventListener('click', async () => {
                    try {
                        const data = await ipcRenderer.invoke('load-config');
                        const result = await ipcRenderer.invoke('save-config', {
                            ...data,
                            masterData: masterData
                        });
                        if (!result) throw new Error('Failed to save master data');
                        alert('Master data saved successfully!');
                        await loadMasterData();
                } catch (error) {
                        console.error('Error saving master data:', error);
                        alert('Error saving master data: ' + error.message);
                    }
                });
            }

            const newMasterData = document.getElementById('new-master-data');
            if (newMasterData) {
                newMasterData.addEventListener('click', () => {
                    const newRow = {
                        id: nextId++,
                        chipId: '',
                        charCode: '',
                        roomName: '',
                        bedName: '',
                        shape: '',
                        sa: '',
                        v1: '',
                        v2: '',
                        v3: '',
                        v4: '',
                        v5: '',
                        v6: ''
                    };
                    masterData.push(newRow);
                    updateMasterDataTable();
                });
            }

            const deleteMasterData = document.getElementById('delete-master-data');
            if (deleteMasterData) {
                deleteMasterData.addEventListener('click', () => {
                    if (selectedRow === null) {
                        alert('Silakan pilih baris yang akan dihapus');
                        return;
                    }
                    if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                        masterData = masterData.filter(row => row.id !== selectedRow);
                        selectedRow = null;
                        updateMasterDataTable();
                    }
                });
            }

            const importSounds = document.getElementById('import-sounds');
            if (importSounds) {
                importSounds.addEventListener('click', async () => {
                    try {
                        // Tampilkan loading state
                        importSounds.disabled = true;
                        importSounds.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Importing...';

                        const importedFiles = await ipcRenderer.invoke('select-sound-files');
                        
                        if (importedFiles && importedFiles.length > 0) {
                            // Refresh sound files list
                            loadSoundFiles();
                            updateSoundsIndicator();
                            
                            // Show success notification
                            showNotification('success', `Berhasil mengimpor ${importedFiles.length} file suara`);
                            
                            // Update master data table to show new sound options
                            updateMasterDataTable();
                        }
                    } catch (error) {
                        console.error('Error importing sounds:', error);
                        showNotification('error', `Gagal mengimpor file suara: ${error.message}`);
                    } finally {
                        // Reset button state
                        importSounds.disabled = false;
                        importSounds.innerHTML = '<i class="fas fa-file-audio mr-2"></i> Import Sounds';
                    }
                });
            }

            const masterConnectBtn = document.getElementById('master-connection-btn');
            
            if (masterConnectBtn) {
                masterConnectBtn.addEventListener('click', async () => {
                    const comPort = document.getElementById('master-com').value;
                    const baudRate = 9600;
                    
                    if (masterIsConnected) {
                        // Jika sudah terkoneksi, lakukan disconnect
                        try {
                            masterConnectBtn.disabled = true;
                            masterConnectBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Disconnecting...';
                            
                            await ipcRenderer.invoke('disconnect-port');
                            masterIsConnected = false;
                            masterSelectedPort = "";
                            isConnected = false;
                            
                            updateMasterConnectionStatus();
                            updateConnectionStatus();
                            
                            showNotification('info', 'Berhasil memutuskan koneksi');
                            
                            // Reset button state
                            masterConnectBtn.disabled = false;
                            masterConnectBtn.innerHTML = '<i class="fas fa-plug mr-2"></i> Connect';
                        } catch (error) {
                            console.error('Disconnection error:', error);
                            showNotification('error', 'Gagal memutuskan koneksi dari port.');
                            
                            // Reset button state
                            masterConnectBtn.disabled = false;
                            masterConnectBtn.innerHTML = '<i class="fas fa-power-off mr-2"></i> Disconnect';
                        }
                    } else {
                        // Jika belum terkoneksi, lakukan connect
                        if (!comPort) {
                            showNotification('error', 'Silakan pilih COM port terlebih dahulu');
                            return;
                        }
                        
                        try {
                            // Tampilkan loading state
                            masterConnectBtn.disabled = true;
                            masterConnectBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Connecting...';
                            
                            const result = await ipcRenderer.invoke('connect-port', { port: comPort, baudRate });
                            console.log('Connection result:', result);
                            
                            // Update status koneksi
                            masterIsConnected = true;
                            masterSelectedPort = comPort;
                            isConnected = true;
                            
                            // Update UI
                            updateMasterConnectionStatus();
                            updateConnectionStatus();
                            
                            // Tampilkan notifikasi
                            showNotification('success', `Berhasil terhubung ke port ${comPort}`);
                            addDebugMessage(`Connected to ${comPort} @ ${baudRate} baud`, 'success');
                            
                            // Update button state
                            masterConnectBtn.disabled = false;
                            masterConnectBtn.innerHTML = '<i class="fas fa-power-off mr-2"></i> Disconnect';
                        } catch (error) {
                            console.error('Connection error:', error);
                            showNotification('error', 'Gagal terhubung ke port. Silakan coba lagi.');
                            addDebugMessage(`Connection error: ${error.message}`, 'error');
                            
                            // Reset connection status
                            masterIsConnected = false;
                            masterSelectedPort = "";
                            isConnected = false;
                            
                            // Reset button state
                            masterConnectBtn.disabled = false;
                            masterConnectBtn.innerHTML = '<i class="fas fa-plug mr-2"></i> Connect';
                            
                            updateMasterConnectionStatus();
                            updateConnectionStatus();
                        }
                    }
                });
            }

            const masterSaveBtn = document.getElementById('master-save-btn');
            if (masterSaveBtn) {
                masterSaveBtn.addEventListener('click', async function() {
                    try {
                        const data = await ipcRenderer.invoke('load-config');
                        const newMasterSettings = {
                            com: document.getElementById('master-com').value,
                            name: document.getElementById('master-name').value,
                            bot: document.getElementById('master-bot').value,
                            idChat: document.getElementById('master-idchat').value,
                            server: document.getElementById('master-server').value
                        };
                        
                        const result = await ipcRenderer.invoke('save-config', {
                            ...data,
                            masterSettings: newMasterSettings
                        });
                        
                        if (!result) throw new Error('Failed to save master settings');
                        masterSettings = newMasterSettings;
                        alert('Settings saved successfully!');
                } catch (error) {
                        console.error('Error saving settings:', error);
                        alert('Error saving settings: ' + error.message);
                    }
                });
            }

            const fabMasterSettings = document.getElementById('fab-master-settings');
            const masterDataPasswordModal = document.getElementById('master-data-password-modal');
            const masterDataPasswordInput = document.getElementById('master-data-password-input');
            const masterDataPasswordError = document.getElementById('master-data-password-error');
            const masterDataPasswordSubmit = document.getElementById('master-data-password-submit');
            const masterDataPasswordCancel = document.getElementById('master-data-password-cancel');

            if (fabMasterSettings) {
                fabMasterSettings.addEventListener('click', () => {
                    masterDataPasswordModal.classList.remove('hidden');
                    masterDataPasswordInput.value = '';
                    masterDataPasswordError.classList.add('hidden');
                    masterDataPasswordInput.focus();
                });
            }

            if (masterDataPasswordSubmit) {
                masterDataPasswordSubmit.addEventListener('click', async () => {
                    const password = masterDataPasswordInput.value;
                    if (password === 'NHX)(*&^') {
                        masterDataPasswordModal.classList.add('hidden');
                        const settingsModal = document.getElementById('master-settings-modal');
                        settingsModal.classList.remove('hidden');
                        await loadMasterData();
                    } else {
                        masterDataPasswordError.classList.remove('hidden');
                        masterDataPasswordInput.value = '';
                        masterDataPasswordInput.focus();
                    }
                });
            }

            if (masterDataPasswordCancel) {
                masterDataPasswordCancel.addEventListener('click', () => {
                    masterDataPasswordModal.classList.add('hidden');
                });
            }

            const closeMasterSettings = document.getElementById('close-master-settings');
            if (closeMasterSettings) {
                closeMasterSettings.addEventListener('click', () => {
                    document.getElementById('master-settings-modal').classList.add('hidden');
                });
            }

            const fabMasterSettings2 = document.getElementById('fab-master-settings2');
            if (fabMasterSettings2) {
                fabMasterSettings2.addEventListener('click', async () => {
                    const settingsModal = document.getElementById('master-settings2-modal');
                    settingsModal.classList.remove('hidden');
                    await populateMasterComPorts();
                    await loadMasterSettings();
                    
                    document.getElementById('master-com').value = masterSettings.com || "";
                    document.getElementById('master-name').value = masterSettings.name || "";
                    document.getElementById('master-bot').value = masterSettings.bot || "";
                    document.getElementById('master-idchat').value = masterSettings.idChat || "";
                    document.getElementById('master-server').value = masterSettings.server || "";
                });
            }

            const closeMasterSettings2 = document.getElementById('close-master-settings2');
            if (closeMasterSettings2) {
                closeMasterSettings2.addEventListener('click', () => {
                    document.getElementById('master-settings2-modal').classList.add('hidden');
                });
            }

            if (masterDataPasswordInput) {
                masterDataPasswordInput.addEventListener('keypress', async (e) => {
                    if (e.key === 'Enter') {
                        masterDataPasswordSubmit.click();
                    }
                });

                masterDataPasswordInput.addEventListener('input', () => {
                    masterDataPasswordError.classList.add('hidden');
                });
            }

            // Close modal when clicking outside
            masterDataPasswordModal.addEventListener('click', (e) => {
                if (e.target === masterDataPasswordModal) {
                    masterDataPasswordModal.classList.add('hidden');
                }
            });

            function showNotification(type, message, duration = 3000) {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                
                const bgColor = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                }[type] || 'bg-gray-500';
                
                notification.className = `${bgColor} text-white px-4 py-2 rounded shadow-lg mb-2 flex items-center`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
                    <span>${message}</span>
                `;
                
                container.appendChild(notification);
                
                if (!message.includes('Mengecek')) {
                    setTimeout(() => {
                        notification.remove();
                    }, duration);
                }
                
                return notification;
            }

            function updateConnectionStatus() {
                if (standbyMode) {
                    setStandbyIndicator('yellow');
                } else if (masterIsConnected) {
                    setStandbyIndicator('gray');
                } else {
                    setStandbyIndicator('red');
                }
            }

            function updateMasterConnectionStatus() {
                const statusElement = document.getElementById('master-connection-status');
                const connectBtn = document.getElementById('master-connection-btn');
                const standbyIndicator = document.getElementById('standby-indicator');
                const serialMonitor = document.getElementById('serial-monitor');
                
                if (!statusElement || !connectBtn) return;
                
                // Pastikan elemen status koneksi selalu terlihat
                statusElement.classList.remove('hidden');
                
                if (masterIsConnected) {
                    // Update status koneksi
                    statusElement.innerHTML = `
                        <p class="text-sm flex items-center">
                            <i class="fas fa-circle mr-2 text-green-500"></i>
                            <span>Connected to ${masterSelectedPort} @ 9600 baud</span>
                        </p>
                    `;
                    
                    // Update tombol ke mode Disconnect
                    connectBtn.innerHTML = '<i class="fas fa-power-off mr-2"></i> Disconnect';
                    connectBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    connectBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    connectBtn.disabled = false;

                    // Update indikator berdasarkan mode standby
                    if (standbyMode) {
                        setStandbyIndicator('yellow');
                    } else {
                        setStandbyIndicator('gray');
                    }

                    // Pastikan serial monitor terlihat
                    serialMonitor.classList.remove('hidden');
                    
                    // Tambahkan pesan debug
                    addDebugMessage('Connection status: Connected', 'success');
                } else {
                    // Update status koneksi
                    statusElement.innerHTML = `
                        <p class="text-sm flex items-center">
                            <i class="fas fa-circle mr-2 text-gray-500"></i>
                            <span>Disconnected</span>
                        </p>
                    `;
                    
                    // Update tombol ke mode Connect
                    connectBtn.innerHTML = '<i class="fas fa-plug mr-2"></i> Connect';
                    connectBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    connectBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    connectBtn.disabled = false;

                    // Update indikator berdasarkan mode standby
                    if (standbyMode) {
                        setStandbyIndicator('yellow');
                    } else {
                        setStandbyIndicator('red');
                    }
                    
                    // Sembunyikan serial monitor
                    serialMonitor.classList.add('hidden');
                    
                    // Tambahkan pesan debug
                    addDebugMessage('Connection status: Disconnected', 'error');
                }
            }

            async function populateMasterComPorts() {
                try {
                    const ports = await ipcRenderer.invoke('get-ports');
                    const comSelect = document.getElementById('master-com');
                    while (comSelect.options.length > 1) {
                        comSelect.remove(1);
                    }
                    ports.forEach(port => {
                        const option = document.createElement('option');
                        option.value = port.path;
                        option.textContent = `${port.path} (${port.manufacturer})`;
                        comSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error getting ports:', error);
                }
            }

            function loadSoundFiles() {
                const fs = require('fs');
                const path = require('path');
                const appPath = require('electron').remote ? require('electron').remote.app.getAppPath() : require('@electron/remote').app.getAppPath();
                const soundsDir = path.join(appPath, 'sounds');
                
                try {
                    if (!fs.existsSync(soundsDir)) {
                        fs.mkdirSync(soundsDir);
                    }
                    soundFiles = fs.readdirSync(soundsDir).filter(f => f.endsWith('.wav'));
                    console.log('Loaded sound files:', soundFiles);
                } catch (error) {
                    console.error('Error loading sound files:', error);
                }
            }
            
            function updateSoundsIndicator() {
                const el = document.getElementById('sounds-indicator');
                if (!el) return;
                
                if (soundFiles && soundFiles.length > 0) {
                    el.classList.remove('bg-red-500');
                    el.classList.add('bg-green-500');
                } else {
                    el.classList.remove('bg-green-500');
                    el.classList.add('bg-red-500');
                }
            }

            async function loadMasterData() {
                try {
                    const data = await ipcRenderer.invoke('load-config');
                    masterData = data.masterData || [];
                    if (masterData.length > 0) {
                        nextId = Math.max(...masterData.map(r => r.id)) + 1;
                        }
                    updateMasterDataTable();
                } catch (error) {
                    console.error('Error loading data:', error);
                    alert('Gagal memuat data: ' + error.message);
                }
            }

            function updateMasterDataTable() {
                const tbody = document.getElementById('master-settings-table');
                tbody.innerHTML = '';

                masterData.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-id', row.id);
                    tr.className = selectedRow === row.id ? 'bg-blue-50' : '';
                    tr.onclick = (e) => {
                        if (e.target.tagName.toLowerCase() === 'select') return;
                        selectedRow = row.id;
                        updateMasterDataTable();
                    };

                    const charCodeOptions = generateCharCodeOptions();
                    const charCodeSelect = `<select class="w-full p-1 border rounded text-xs font-mono">${
                        charCodeOptions.map(code => `<option value="${code}" ${row.charCode === code ? 'selected' : ''}>${code}</option>`).join('')
                    }</select>`;

                    tr.innerHTML = `
                        <td class="py-1 px-2 border text-center text-xs">${row.id}</td>
                        <td class="py-1 px-2 border"><input type="text" class="w-full p-1 border rounded text-xs font-mono" value="${row.chipId || ''}" placeholder="Chip ID"></td>
                        <td class="py-1 px-2 border">${charCodeSelect}</td>
                        <td class="py-1 px-2 border"><input type="text" class="w-full p-1 border rounded text-xs" value="${row.roomName}"></td>
                        <td class="py-1 px-2 border"><input type="text" class="w-full p-1 border rounded text-xs" value="${row.bedName}"></td>
                        <td class="py-1 px-2 border"><input type="text" class="w-full p-1 border rounded text-xs" value="${row.shape}"></td>
                        <td class="py-1 px-2 border"><input type="text" class="w-full p-1 border rounded text-xs" value="${row.sa}"></td>
                        <td class="py-1 px-2 border"><select class="w-full p-1 border rounded text-xs font-mono">${soundOptions(row.v1)}</select></td>
                        <td class="py-1 px-2 border"><select class="w-full p-1 border rounded text-xs font-mono">${soundOptions(row.v2)}</select></td>
                        <td class="py-1 px-2 border"><select class="w-full p-1 border rounded text-xs font-mono">${soundOptions(row.v3)}</select></td>
                        <td class="py-1 px-2 border"><select class="w-full p-1 border rounded text-xs font-mono">${soundOptions(row.v4)}</select></td>
                        <td class="py-1 px-2 border"><select class="w-full p-1 border rounded text-xs font-mono">${soundOptions(row.v5)}</select></td>
                        <td class="py-1 px-2 border"><select class="w-full p-1 border rounded text-xs font-mono">${soundOptions(row.v6)}</select></td>
                    `;

                    const inputs = tr.querySelectorAll('input');
                    inputs.forEach((input, index) => {
                        const fields = ['chipId', 'roomName', 'bedName', 'shape', 'sa'];
                        input.addEventListener('change', (e) => {
                            row[fields[index]] = e.target.value;
                        });
                        input.addEventListener('mousedown', e => e.stopPropagation());
                        input.addEventListener('click', e => e.stopPropagation());
                    });
                    
                    const selects = tr.querySelectorAll('select');
                    selects.forEach((select, idx) => {
                        if (idx === 0) { // Charcode select
                            select.addEventListener('change', (e) => {
                                row.charCode = e.target.value;
                            });
                        } else { // Sound selects
                            const fields = ['v1', 'v2', 'v3', 'v4', 'v5', 'v6'];
                            select.addEventListener('change', (e) => {
                                row[fields[idx - 1]] = e.target.value;
                            });
                        }
                        select.addEventListener('mousedown', e => e.stopPropagation());
                        select.addEventListener('click', e => e.stopPropagation());
                    });

                    tbody.appendChild(tr);
                });
            }

            function soundOptions(selected) {
                return `<option value="">-</option>` + soundFiles.map(f => 
                    `<option value="${f}" ${selected === f ? 'selected' : ''} class="text-xs font-mono">${f}</option>`
                ).join('');
            }

            async function loadAlertSettings() {
                try {
                    const data = await ipcRenderer.invoke('load-config');
                    if (data.alertSettings) {
                        alertSettings = data.alertSettings;
                        displayFormat = alertSettings.displayFormat === 'custom' ? alertSettings.customFormat : alertSettings.displayFormat;
                alertDuration = alertSettings.alertDuration;
                soundEnabled = alertSettings.soundEnabled;
                    }
                } catch (error) {
                    console.error('Error loading alert settings:', error);
                }
            }

            async function loadMasterSettings() {
                try {
                    const data = await ipcRenderer.invoke('load-config');
                    if (data.masterSettings) {
                        masterSettings = data.masterSettings;
                } else {
                        masterSettings = { com: "", name: "", bot: "", idChat: "", server: "" };
                }
                } catch (error) {
                    console.error('Error loading master settings:', error);
                }
            }

            async function saveAlertSettings() {
                try {
                    const data = await ipcRenderer.invoke('load-config');
                    const result = await ipcRenderer.invoke('save-config', {
                        ...data,
                        alertSettings: {
                            displayFormat: alertSettings.displayFormat,
                            customFormat: alertSettings.customFormat,
                            alertDuration: alertSettings.alertDuration,
                            soundEnabled: alertSettings.soundEnabled
                        }
                    });
                    return result;
                } catch (error) {
                    console.error('Error saving alert settings:', error);
                    return false;
                }
            }

            ipcRenderer.on('notification', (event, { type, message }) => {
                showNotification(type, message);
            });

            ipcRenderer.on('serial-data', (event, data) => {
                console.log('Received in renderer process:', data);
                addDebugMessage(`Received data: ${data}`, 'info');

                // Parse chip ID dan charCode dari data serial
                let chipId, charCode;
                
                if (data.includes(':')) {
                    // Format dengan colon (untuk standby)
                    const parts = data.split(':');
                    chipId = parts[0];
                    charCode = parts[1] || '';
                } else {
                    // Format tanpa colon (untuk nurse call)
                    chipId = data.substring(0, 12); // 12 karakter pertama adalah chip ID
                    charCode = data.substring(12); // Sisa adalah charCode
                }

                // Jika tombol Get Chip Data aktif dan chip ID berbeda dari yang terakhir
                const getChipDataBtn = document.getElementById('get-chip-data-btn');
                if (getChipDataBtn && getChipDataBtn.classList.contains('active') && chipId !== lastChipId) {
                    navigator.clipboard.writeText(chipId).then(() => {
                        addDebugMessage(`Chip ID ${chipId} copied to clipboard`, 'success');
                        showNotification('success', `Chip ID ${chipId} copied to clipboard`);
                        lastChipId = chipId; // Update chip ID terakhir
                        // Nonaktifkan mode copy setelah berhasil
                        getChipDataBtn.classList.remove('active', 'bg-green-500', 'hover:bg-green-600');
                        getChipDataBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                        addDebugMessage('Get Chip Data mode nonaktif', 'info');
                    }).catch(err => {
                        console.error('Failed to copy chip ID:', err);
                        addDebugMessage('Failed to copy chip ID', 'error');
                    });
                }

                if (charCode === '99') {
                    standbyMode = true;
                    lastStandbyTime = Date.now(); // Update waktu standby terakhir
                    // Kedip hijau sekali
                    setStandbyIndicator('green');
                    setTimeout(() => {
                        setStandbyIndicator('yellow');
                    }, 500);
                    addDebugMessage('Standby mode ON', 'warning');
                } else if (charCode.startsWith('10')) {
                    // Kedip biru sekali
                    setStandbyIndicator('blue');
                    setTimeout(() => {
                        setStandbyIndicator('yellow');
                    }, 500);
                    processCall(charCode, chipId);
                } else {
                    processCall(charCode, chipId);
                }
            });
            
            ipcRenderer.on('serial-monitor-data', (event, data) => {
                const serialData = document.getElementById('serial-data');
                if (!serialData) return;

                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
                
                const dataElement = document.createElement('div');
                dataElement.className = 'mb-1';
                dataElement.innerHTML = `
                    <span class="text-gray-500">[${timeStr}]</span>
                    <span class="text-blue-600">${data}</span>
                `;
                
                serialData.appendChild(dataElement);
                
                serialData.scrollTop = serialData.scrollHeight;
                
                while (serialData.children.length > 100) {
                    serialData.removeChild(serialData.firstChild);
                }
            });

            ipcRenderer.on('serial-error', (event, message) => {
                console.error('Serial port error:', message);
                
                const serialData = document.getElementById('serial-data');
                if (!serialData) return;

                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
                
                const errorElement = document.createElement('div');
                errorElement.className = 'mb-1';
                errorElement.innerHTML = `
                    <span class="text-gray-500">[${timeStr}]</span>
                    <span class="text-red-600">Error: ${message}</span>
                `;
                
                serialData.appendChild(errorElement);
                serialData.scrollTop = serialData.scrollHeight;
                
                masterIsConnected = false;
                masterSelectedPort = "";
                    isConnected = false;
                updateMasterConnectionStatus();
                    updateConnectionStatus();
            });

            loadSoundFiles();
            updateSoundsIndicator();
            loadMasterData();
            loadAlertSettings();
            loadMasterSettings();

            // Test buttons in serial monitor
            const test99Btn = document.getElementById('test-99-btn');
            const test101Btn = document.getElementById('test-101-btn');
            const test901Btn = document.getElementById('test-901-btn');
            
            if (test99Btn) {
                test99Btn.addEventListener('click', () => {
                    processCall('99');
                    addDebugMessage('Test code 99 (Standby ON)', 'warning');
                });
            }
            
            if (test101Btn) {
                test101Btn.addEventListener('click', () => {
                    processCall('101');
                    addDebugMessage('Test code 101 (Call)', 'info');
                });
            }
            
            if (test901Btn) {
                test901Btn.addEventListener('click', () => {
                    processCall('901');
                    addDebugMessage('Test code 901 (Reset)', 'success');
                });
            }

            // Tambahkan fungsi untuk menginisialisasi serial monitor saat halaman dimuat
            function initializeSerialMonitor() {
                const serialMonitor = document.getElementById('serial-monitor');
                const serialData = document.getElementById('serial-data');
                
                if (serialMonitor && serialData) {
                    // Bersihkan data serial
                    serialData.innerHTML = '';

                    // Tambahkan pesan selamat datang
                    addDebugMessage('Serial monitor initialized', 'info');
                    addDebugMessage('Waiting for connection...', 'info');
                    
                    // Sembunyikan serial monitor jika tidak terkoneksi
                    if (!masterIsConnected) {
                        serialMonitor.classList.add('hidden');
                    } else {
                        serialMonitor.classList.remove('hidden');
                    }
                }
            }

            // Panggil fungsi ini saat dokumen dimuat
            initializeSerialMonitor();

            // Test buttons in serial monitor
            const getChipDataBtn = document.getElementById('get-chip-data-btn');
            let lastChipId = ''; // Tambahkan variabel untuk menyimpan chip ID terakhir
            
            if (getChipDataBtn) {
                getChipDataBtn.addEventListener('click', () => {
                    // Tambahkan pesan instruksi
                    addDebugMessage('Silakan scan chip untuk mendapatkan data', 'info');
                    addDebugMessage('Format data: [ChipID][CharCode]', 'info');
                    addDebugMessage('Contoh: 742E560B65F4101', 'info');
                });
            }

            // Tambahkan fungsi untuk toggle tombol Get Chip Data
            if (getChipDataBtn) {
                getChipDataBtn.addEventListener('click', () => {
                    getChipDataBtn.classList.toggle('active');
                    if (getChipDataBtn.classList.contains('active')) {
                        getChipDataBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                        getChipDataBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                        addDebugMessage('Get Chip Data mode aktif - Chip ID akan di-copy ke clipboard', 'info');
                        lastChipId = ''; // Reset chip ID terakhir saat mode aktif
                    } else {
                        getChipDataBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                        getChipDataBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                        addDebugMessage('Get Chip Data mode nonaktif', 'info');
                    }
                });
            }

            // Hapus event listener yang lama jika ada
            ipcRenderer.removeAllListeners('serial-data');

            // Tambahkan event listener untuk serial data (hanya satu kali)
            ipcRenderer.on('serial-data', (event, data) => {
                console.log('Received in renderer process:', data);
                addDebugMessage(`Received data: ${data}`, 'info');

                // Parse chip ID dan charCode dari data serial
                let chipId, charCode;
                
                if (data.includes(':')) {
                    // Format dengan colon (untuk standby)
                    const parts = data.split(':');
                    chipId = parts[0];
                    charCode = parts[1] || '';
                } else {
                    // Format tanpa colon (untuk nurse call)
                    chipId = data.substring(0, 12); // 12 karakter pertama adalah chip ID
                    charCode = data.substring(12); // Sisa adalah charCode
                }

                // Jika tombol Get Chip Data aktif dan chip ID berbeda dari yang terakhir
                const getChipDataBtn = document.getElementById('get-chip-data-btn');
                if (getChipDataBtn && getChipDataBtn.classList.contains('active') && chipId !== lastChipId) {
                    navigator.clipboard.writeText(chipId).then(() => {
                        addDebugMessage(`Chip ID ${chipId} copied to clipboard`, 'success');
                        showNotification('success', `Chip ID ${chipId} copied to clipboard`);
                        lastChipId = chipId; // Update chip ID terakhir
                        // Nonaktifkan mode copy setelah berhasil
                        getChipDataBtn.classList.remove('active', 'bg-green-500', 'hover:bg-green-600');
                        getChipDataBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                        addDebugMessage('Get Chip Data mode nonaktif', 'info');
                    }).catch(err => {
                        console.error('Failed to copy chip ID:', err);
                        addDebugMessage('Failed to copy chip ID', 'error');
                    });
                }

                if (charCode === '99') {
                    standbyMode = true;
                    lastStandbyTime = Date.now(); // Update waktu standby terakhir
                    // Kedip hijau sekali
                    setStandbyIndicator('green');
                    setTimeout(() => {
                        setStandbyIndicator('yellow');
                    }, 500);
                    addDebugMessage('Standby mode ON', 'warning');
                } else if (charCode.startsWith('10')) {
                    // Kedip biru sekali
                    setStandbyIndicator('blue');
                    setTimeout(() => {
                        setStandbyIndicator('yellow');
                    }, 500);
                    processCall(charCode, chipId);
                } else {
                    processCall(charCode, chipId);
                }
            });
        });

        function showNotification(type, message) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            
            const bgColor = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            }[type] || 'bg-gray-500';
            
            notification.className = `${bgColor} text-white px-4 py-2 rounded shadow-lg mb-2 flex items-center`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(notification);
            
            if (!message.includes('Mengecek')) {
                setTimeout(() => {
                    notification.remove();
                }, duration);
            }
            
            return notification;
        }

        function updateConnectionStatus() {
            if (standbyMode) {
                setStandbyIndicator('yellow');
            } else if (masterIsConnected) {
                setStandbyIndicator('gray');
            } else {
                setStandbyIndicator('red');
            }
        }
        
        function blinkStandbyIndicator(color, times = 1, callback) {
            const standbyIndicator = document.getElementById('standby-indicator');
            let count = 0;
            
            function blink() {
                if (count < times * 2) {
                    standbyIndicator.classList.toggle(`bg-${color}-500`);
                    setTimeout(blink, 500);
                    count++;
                } else {
                    if (callback) {
                        callback();
                    }
                }
            }
            
            blink();
        }
        
        function formatDateTime(date) {
            const timeStr = date.toLocaleTimeString('en-US', { hour12: false });
            return `${timeStr}.${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}`;
        }

        // Tambahkan fungsi untuk mengecek kelengkapan data
        function isValidMasterData(data) {
            if (!data) return false;
            
            // Cek apakah data memiliki nilai yang dibutuhkan
            if (!data.roomName || data.roomName.trim() === '') return false;
            if (!data.bedName || data.bedName.trim() === '') return false;
            
            // Cek minimal satu file suara harus ada
            const hasSound = [data.v1, data.v2, data.v3, data.v4, data.v5, data.v6].some(v => v && v.trim() !== '');
            if (!hasSound) return false;
            
            return true;
        }

        function processCall(code, chipId) {
            console.log('Processing call with code:', code, 'and chip ID:', chipId);
            addDebugMessage(`Processing code: ${code} with chip ID: ${chipId}`, 'info');
            
            // Khusus untuk kode standby
            if (code === '99') {
                standbyMode = true;
                setStandbyIndicator('green');
                setTimeout(() => {
                    setStandbyIndicator('yellow');
                }, 500);
                addDebugMessage('Standby mode ON', 'warning');
                return;
            }

            // Khusus untuk kode 100 (keluar dari standby)
            if (code === '100') {
                standbyMode = false;
                updateConnectionStatus();
                showNotification('info', 'Sistem keluar dari mode standby');
                addDebugMessage('Standby mode OFF', 'success');
                return;
            }
            
            // Untuk kode reset (90x atau 90xx)
            if (code.startsWith('90')) {
                console.log('Processing reset code:', code);
                addDebugMessage(`Reset code: ${code}`, 'warning');
                
                const bedNumber = code.substring(2);
                const originalCode = `10${bedNumber}`;
                
                // Cek apakah kode original ada di master data dan memiliki data lengkap
                const originalData = masterData.find(d => d.charCode === originalCode && d.chipId === chipId);
                if (!isValidMasterData(originalData)) {
                    console.log('Original code not found or incomplete in master data:', originalCode);
                    addDebugMessage(`Code ${originalCode} not found or has incomplete data`, 'error');
                    return;
                }
                
                console.log('Reset code detected. Original code:', originalCode);
                
                const alertIndex = activeAlerts.findIndex(alert => alert.code === originalCode && alert.chipId === chipId);
                if (alertIndex !== -1) {
                    addDebugMessage(`Resetting alert for code: ${originalCode}`, 'success');
                    
                    const now = new Date();
                    const resetTimeStr = formatDateTime(now);
                    
                    // Update call history
                    const historyIndex = callHistory.findIndex(call => call.code === originalCode && call.chipId === chipId && call.status === 'active');
                    if (historyIndex !== -1) {
                        callHistory[historyIndex].status = 'completed';
                        callHistory[historyIndex].resetTime = now;
                        callHistory[historyIndex].resetTimeStr = resetTimeStr;
                    }
                    
                    // Update active alert
                    activeAlerts[alertIndex].status = 'completed';
                    activeAlerts[alertIndex].resetTime = now;
                    activeAlerts[alertIndex].resetTimeStr = resetTimeStr;
                    
                    // Update UI
                    const alertElement = document.querySelector(`[data-alert-id="${activeAlerts[alertIndex].id}"]`);
                    if (alertElement) {
                        alertElement.classList.remove('bg-red-100', 'border-red-500');
                        alertElement.classList.add('bg-green-100', 'border-green-500');
                        
                        const title = alertElement.querySelector('h3');
                        const time = alertElement.querySelector('span.bg-red-500');
                        const button = alertElement.querySelector('button');
                        const roomText = alertElement.querySelector('p.text-red-600');
                        const codeText = alertElement.querySelector('span.text-gray-500');
                        
                        if (title) title.classList.replace('text-red-800', 'text-blue-800');
                        if (time) {
                            time.classList.remove('bg-red-500');
                            time.classList.add('bg-blue-500');
                        }
                        if (button) {
                            button.classList.remove('bg-red-500', 'hover:bg-red-600');
                            button.classList.add('bg-blue-500', 'hover:bg-blue-600');
                            button.innerHTML = '<i class="fas fa-check mr-1"></i> Selesai';
                        }
                        if (roomText) roomText.classList.replace('text-red-600', 'text-blue-600');
                        if (codeText) codeText.classList.replace('text-gray-500', 'text-blue-500');
                        
                        setTimeout(() => {
                            const idx = activeAlerts.findIndex(a => a.id === activeAlerts[alertIndex].id);
                            if (idx !== -1) {
                                activeAlerts.splice(idx, 1);
                                updateActiveAlerts();
                            }
                        }, 30000);
                    }
                    
                    updateActiveAlerts();
                    updateCallHistory();

                    // Tambahkan notifikasi OS untuk reset
                    showOSNotification(
                        'Nurse Call - Reset',
                        `${activeAlerts[alertIndex].display} telah ditangani`,
                        'normal'
                    );
                }
                return;
            }
            
            // Untuk kode panggilan normal (10x atau 10xx)
            if (code.startsWith('10')) {
                // Cek apakah kode ada di master data dan memiliki data lengkap
                const data = masterData.find(d => d.charCode === code && d.chipId === chipId);
                if (!isValidMasterData(data)) {
                    console.log('Call code not found or incomplete in master data:', code);
                    addDebugMessage(`Code ${code} not found or has incomplete data`, 'error');
                    return;
                }
                
                console.log('Processing call code:', code);
                addDebugMessage(`Call code: ${code}`, 'info');
                
                // Kedip biru sekali
                setStandbyIndicator('blue');
                setTimeout(() => {
                    setStandbyIndicator('yellow');
                }, 500);

                // Proses panggilan
                const now = new Date();
                const timeStr = formatDateTime(now);
                
                // Play sounds
                const sounds = [];
                if (data.v1) sounds.push(data.v1);
                if (data.v2) sounds.push(data.v2);
                if (data.v3) sounds.push(data.v3);
                if (data.v4) sounds.push(data.v4);
                if (data.v5) sounds.push(data.v5);
                if (data.v6) sounds.push(data.v6);
                
                if (sounds.length > 0) {
                    playSoundsInSequence(sounds);
                }
            
                const displayText = `${data.roomName} - ${data.bedName}`;
            
                const callEntry = {
                    id: Date.now(),
                    chipId: chipId,
                    code: code,
                    room: data.roomName,
                    bed: data.bedName,
                    display: displayText,
                    time: timeStr,
                    timestamp: now,
                    status: 'active',
                    resetTime: null,
                    resetTimeStr: ''
                };
                
                callHistory.unshift(callEntry);
                activeAlerts.push({...callEntry});
                
                updateActiveAlerts();
                updateCallHistory();
                addDebugMessage(`Alert created for code: ${code}`, 'success');
            }
        }
        
        function playSoundsInSequence(sounds) {
            let currentIndex = 0;
            
            function playNext() {
                if (currentIndex < sounds.length) {
                    const sound = new Audio();
                    const soundPath = `sounds/${sounds[currentIndex]}`;
                    sound.src = soundPath;
                    
                    sound.addEventListener('loadstart', () => console.log('Sound loading started:', soundPath));
                    sound.addEventListener('canplay', () => console.log('Sound can play:', soundPath));
                    sound.addEventListener('playing', () => console.log('Sound is playing:', soundPath));
                    sound.addEventListener('ended', () => console.log('Sound ended:', soundPath));
                    sound.addEventListener('error', (e) => console.error('Sound error:', e, soundPath));
                    
                    sound.oncanplaythrough = () => {
                        console.log('Sound can play through:', soundPath);
                        sound.play().then(() => {
                            console.log('Sound started playing successfully:', soundPath);
                        }).catch(e => {
                            console.error('Error playing sound:', e, soundPath);
                            currentIndex++;
                            playNext();
                        });
                    };
                    
                    sound.onended = () => {
                        console.log('Sound finished playing:', soundPath);
                        currentIndex++;
                        playNext();
                    };
                    
                    sound.onerror = (e) => {
                        console.error('Error loading sound:', e, soundPath);
                        currentIndex++;
                        playNext();
                    };
                } else {
                    console.log('Finished playing all sounds');
                }
            }
            
            if (sounds.length > 0) {
                playNext();
            } else {
                console.log('No sounds to play');
            }
        }
        
        // Tambahkan fungsi untuk mengirim notifikasi sistem
        async function showOSNotification(title, body, urgency = 'normal') {
            try {
                await ipcRenderer.invoke('show-system-notification', { title, body, urgency });
            } catch (error) {
                console.error('Error showing system notification:', error);
            }
        }

        function updateActiveAlerts() {
            const container = document.getElementById('active-alerts');
            
            if (activeAlerts.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col justify-center items-center text-gray-400 h-full">
                        <i class="fas fa-bell-slash text-6xl mb-2"></i>
                        <p class="text-lg">Tidak ada peringatan aktif</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            activeAlerts.forEach(alert => {
                const alertElement = document.createElement('div');
                const isCompleted = alert.status === 'completed';
                
                alertElement.className = `border-l-4 p-4 ${
                    isCompleted ? 'bg-green-100 border-green-500 alert-completed' : 'bg-red-100 border-red-500 alert-pulse'
                }`;
                alertElement.setAttribute('data-alert-id', alert.id);
                alertElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-lg ${isCompleted ? 'text-blue-800' : 'text-red-800'}">${alert.display}</h3>
                            <p class="text-sm ${isCompleted ? 'text-blue-600' : 'text-red-600'}">Ruangan ${alert.room}</p>
                        </div>
                        <span class="text-xs text-white px-2 py-1 rounded ${isCompleted ? 'bg-blue-500' : 'bg-red-500'}">${alert.time}</span>
                    </div>
                    <div class="mt-2 flex justify-between items-center">
                        <span class="text-xs ${isCompleted ? 'text-blue-500' : 'text-gray-500'}">Kode: ${alert.code}</span>
                        <button onclick="removeAlert(${alert.id})" class="text-xs text-white px-2 py-1 rounded ${
                            isCompleted ? 'bg-blue-500 hover:bg-blue-600' : 'bg-red-500 hover:bg-red-600'
                        }">
                            <i class="fas fa-${isCompleted ? 'check' : 'bell'} mr-1"></i> ${isCompleted ? 'Selesai' : 'Nurse Call'}
                        </button>
                    </div>
                `;
                container.appendChild(alertElement);

                // Kirim notifikasi OS untuk alert baru
                if (!isCompleted) {
                    showOSNotification(
                        'Nurse Call',
                        `${alert.display} membutuhkan bantuan`,
                        'critical'
                    );
                }

                // Jika alert sudah selesai, set timer untuk menghapusnya setelah 30 detik
                if (isCompleted) {
                    setTimeout(() => {
                        const idx = activeAlerts.findIndex(a => a.id === alert.id);
                        if (idx !== -1) {
                            activeAlerts.splice(idx, 1);
                            updateActiveAlerts();
                        }
                    }, 30000);
                }
            });
        }
        
        function updateCallHistory() {
            const tbody = document.getElementById('call-history');
            
            if (callHistory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="py-4 text-center text-gray-500">
                            No call history yet
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            callHistory.forEach(call => {
                const row = document.createElement('tr');
                row.className = call.status === 'active' ? 'bg-red-50' : '';
                
                // Hitung Elapse
                let elapseTime = '00:00:00';
                if (call.resetTime && call.timestamp) {
                    const diffInSeconds = Math.floor((call.resetTime - call.timestamp) / 1000);
                    const hours = Math.floor(diffInSeconds / 3600);
                    const minutes = Math.floor((diffInSeconds % 3600) / 60);
                    const seconds = diffInSeconds % 60;
                    elapseTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                
                row.innerHTML = `
                    <td class="py-2 px-2 font-mono text-sm whitespace-nowrap overflow-hidden text-ellipsis">${call.code}</td>
                    <td class="py-2 px-2 text-sm whitespace-nowrap overflow-hidden text-ellipsis">${call.room}</td>
                    <td class="py-2 px-2 text-sm whitespace-nowrap overflow-hidden text-ellipsis">${call.bed}</td>
                    <td class="py-2 px-2 text-sm whitespace-nowrap overflow-hidden text-ellipsis">${call.time}</td>
                    <td class="py-2 px-2 text-sm whitespace-nowrap overflow-hidden text-ellipsis">${call.resetTimeStr || ''}</td>
                    <td class="py-2 px-2 font-mono text-sm whitespace-nowrap">${elapseTime}</td>
                    <td class="py-2 px-2 text-center text-base">
                        ${call.status === 'active' ? '' : ''}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function setStandbyIndicator(color) {
            const standbyIndicator = document.getElementById('standby-indicator');
            if (!standbyIndicator) return;
            
            standbyIndicator.classList.remove('bg-red-500', 'bg-green-500', 'bg-yellow-500', 'bg-gray-500', 'bg-blue-500');
            
            if (color === 'red') {
                standbyIndicator.classList.add('bg-red-500');
            } else if (color === 'green') {
                standbyIndicator.classList.add('bg-green-500');
            } else if (color === 'yellow') {
                standbyIndicator.classList.add('bg-yellow-500');
            } else if (color === 'gray') {
                standbyIndicator.classList.add('bg-gray-500');
            } else if (color === 'blue') {
                standbyIndicator.classList.add('bg-blue-500');
            }
        }

        // Tambahkan fungsi debug untuk serial monitor
        function addDebugMessage(message, type = 'info') {
            const serialData = document.getElementById('serial-data');
            if (!serialData) return;

            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
            
            const dataElement = document.createElement('div');
            dataElement.className = 'mb-1';
            
            let color = 'text-blue-600';
            if (type === 'error') color = 'text-red-600';
            if (type === 'success') color = 'text-green-600';
            if (type === 'warning') color = 'text-yellow-600';
            
            dataElement.innerHTML = `
                <span class="text-gray-500">[${timeStr}]</span>
                <span class="${color}">${message}</span>
            `;
            
            serialData.appendChild(dataElement);
            serialData.scrollTop = serialData.scrollHeight;
        }

        // Tambahkan fungsi untuk membuat opsi charcode
        function generateCharCodeOptions() {
            let options = [];
            for (let i = 1; i <= 9; i++) {
                const code = `10${i}`;
                options.push(code);
            }
            return options;
        }

        // Perbaiki fungsi validasi charcode
        function isValidCharCode(code) {
            // Cek format kode (10x atau 90x)
            if (!/^(10|90)\d{1}$/.test(code)) {
                return false;
            }

            const prefix = code.substring(0, 2);
            const number = parseInt(code.substring(2));

            // Validasi range berdasarkan prefix
            if ((prefix === '10' || prefix === '90') && number > 9) {
                showNotification('warning', 'PIN Maksimal adalah 9', 5000);
                return false;
            }

            return true;
        }

        // Tambahkan fungsi untuk cek apakah charcode ada di master data
        function isCharCodeInMasterData(code) {
            return masterData.some(data => data.charCode === code);
        }

        // Modifikasi fungsi validateTestInput untuk mendukung format x dan xx
        function validateTestInput(room, bed) {
            // Pastikan room dan bed adalah string
            const roomStr = room.toString();
            const bedStr = bed.toString();
            
            // Gabungkan menjadi kode
            const code = `10${bedStr}`;
            
            if (!isValidCharCode(code)) {
                return false;
            }
            
            return true;
        }
    </script>
</body>
</html>